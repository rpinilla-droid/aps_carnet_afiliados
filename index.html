<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Validación de Carnet</title>
<script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>
<style>
body {
  font-family: Arial;
  margin: 30px;
}
input {
  display:block;
  margin-bottom: 10px;
  padding: 10px;
  width: 300px;
}
button {
  padding: 10px 20px;
}
</style>
</head>

<body>

<h2>Consulta de Carnet</h2>

<label>Cédula</label>
<input id="cedula" />

<label>Póliza</label>
<input id="poliza" />

<label>Fecha de nacimiento (dd/mm/aaaa)</label>
<input id="fecha" />

<button onclick="validar()">Validar y Descargar Carnet</button>

<script>
async function validar() {

    const cedula = document.getElementById("cedula").value.trim();
    const poliza = document.getElementById("poliza").value.trim();
    const fecha = document.getElementById("fecha").value.trim();

    if (!cedula || !poliza || !fecha) {
        alert("Complete todos los campos");
        return;
    }

    // URL RAW del CSV en GitHub
    const urlCSV = "https://raw.githubusercontent.com/TU_USUARIO/TU_REPO/main/datos.csv";

    const resp = await fetch(urlCSV);
    const texto = await resp.text();

    const lineas = texto.split("\n").map(l => l.trim()).filter(l => l.length > 0);

    // Saltar encabezado
    lineas.shift();

    let encontrado = null;

    for (let fila of lineas) {
        const [nombre, ced, nss, pol, fec] = fila.split(";");

        if (ced.trim() === cedula &&
            pol.trim() === poliza &&
            fec.trim() === fecha) {

            encontrado = { nombre, ced, nss, pol, fec };
            break;
        }
    }

    if (!encontrado) {
        alert("Datos no encontrados o incorrectos.");
        return;
    }

    generarPDF(encontrado);
}


// ========== GENERAR PDF =============
async function generarPDF(d) {

    const templateUrl = "Test_Carnet.pdf"; // súbelo a tu hosting o usa ruta relativa

    const existingPdf = await fetch(templateUrl).then(r => r.arrayBuffer());

    const pdfDoc = await PDFLib.PDFDocument.load(existingPdf);
    const pages = pdfDoc.getPages();
    const page = pages[0];

    // Fuente
    const font = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);

    // Escribir datos en posiciones fijas (ajusta según tu plantilla)
    page.drawText(d.nombre, { x: 80, y: 380, size: 12, font });
    page.drawText(d.ced,    { x: 80, y: 350, size: 12, font });
    page.drawText(d.nss,    { x: 80, y: 320, size: 12, font });
    page.drawText(d.pol,    { x: 80, y: 290, size: 12, font });
    page.drawText(d.fec,    { x: 80, y: 260, size: 12, font });

    const pdfBytes = await pdfDoc.save();

    // Descargar
    const blob = new Blob([pdfBytes], { type: "application/pdf" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "Carnet.pdf";
    a.click();
    URL.revokeObjectURL(url);
}
</script>

</body>
</html>
